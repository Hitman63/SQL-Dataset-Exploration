Use online_shopping;

Select * from customers;
Select * from geolocation;
Select * from order_items;
Select * from orders;
Select * from payments;
Select * from products;
Select * from sellers;

ALTER TABLE products
CHANGE `product category` product_category VARCHAR(255);

ALTER TABLE customers
CHANGE `ï»¿customer_id` customer_id TEXT;

ALTER TABLE products
CHANGE `ï»¿product_id` product_id TEXT;

ALTER TABLE order_items
CHANGE `ï»¿order_id` order_id TEXT;

ALTER TABLE orders
CHANGE `ï»¿order_id` order_id TEXT;

DESCRIBE products;
DESCRIBE order_items;
DESCRIBE customers;

##Basic Problem

##1.List all unique cities where customers are located

select distinct customer_city
from customers ;

##2.Count the number of orders placed in 2017

SELECT COUNT(*) AS total_orders_2017
FROM orders
WHERE YEAR(order_purchase_timestamp) = 2017;

##3.Find the total sales per category

SELECT 
    products.product_category,
    SUM(order_items.price) AS total_sales
FROM order_items
JOIN products
    ON order_items.product_id = products.product_id
GROUP BY products.product_category;

##4.Calculate the percentage of orders that were paid in installments.

SELECT 
    (COUNT(CASE 
        WHEN payment_installments > 1 THEN 1 
     END) * 100.0 / COUNT(*)) AS installment_percentage
FROM payments;

##5.Count the number of customers from each state.

SELECT 
    customer_state,
    COUNT(*) AS total_customers
FROM customers
GROUP BY customer_state
ORDER BY total_customers DESC;

##INTERMEDIATE Problem.

##1.Calculate the number of orders per month in 2018.

SELECT 
    MONTH(order_purchase_timestamp) AS order_month,
    COUNT(order_id) AS total_orders
FROM orders
WHERE YEAR(order_purchase_timestamp) = 2018
GROUP BY MONTH(order_purchase_timestamp)
ORDER BY order_month;

##2.Find the average number of products per order, grouped by customer city.

SELECT
    c.customer_city,
    COUNT(oi.product_id) / COUNT(DISTINCT o.order_id) AS avg_products_per_order
FROM orders o
JOIN order_items oi
    ON o.order_id = oi.order_id
JOIN customers c
    ON o.customer_id = c.customer_id
GROUP BY c.customer_city
ORDER BY avg_products_per_order DESC
LIMIT 10;


##3. Calculate the percentage of total revenue contributed by each product category.

SELECT
    p.product_category,
    ROUND(
        SUM(oi.price) * 100.0 /
        (SELECT SUM(price) FROM order_items),
        2
    ) AS revenue_percentage
FROM order_items oi
JOIN products p
    ON oi.product_id = p.product_id
GROUP BY p.product_category
ORDER BY revenue_percentage DESC;

##4. Identify the correlation between product price and the number of times a product has been purchased.

SELECT
    product_id,
    COUNT(*) AS purchase_frequency,
    ROUND(AVG(price), 2) AS avg_price
FROM order_items
GROUP BY product_id
ORDER BY purchase_frequency DESC;

##5. Calculate the total revenue generated by each seller, and rank them by revenue.

SELECT
    seller_id,
    SUM(price) AS total_revenue,
    RANK() OVER (ORDER BY SUM(price) DESC) AS seller_rank
FROM order_items
GROUP BY seller_id;

##Advanced Problem.

##1.Calculate the moving average of order values for each customer over their order history.
SELECT
    o.customer_id,
    o.order_purchase_timestamp,
    SUM(oi.price) AS order_value,
    AVG(SUM(oi.price)) OVER (
        PARTITION BY o.customer_id
        ORDER BY o.order_purchase_timestamp
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS moving_avg_order_value
FROM orders o
JOIN order_items oi
    ON o.order_id = oi.order_id
GROUP BY
    o.customer_id,
    o.order_id,
    o.order_purchase_timestamp
ORDER BY
    o.customer_id,
    o.order_purchase_timestamp;
    
##2. Calculate the cumulative sales per month for each year.

SELECT
    order_year,
    order_month,
    monthly_sales,
    SUM(monthly_sales) OVER (
        PARTITION BY order_year
        ORDER BY order_month
    ) AS cumulative_sales
FROM (
    SELECT
        YEAR(o.order_purchase_timestamp) AS order_year,
        MONTH(o.order_purchase_timestamp) AS order_month,
        SUM(oi.price) AS monthly_sales
    FROM orders o
    JOIN order_items oi
        ON o.order_id = oi.order_id
    GROUP BY
        YEAR(o.order_purchase_timestamp),
        MONTH(o.order_purchase_timestamp)
) t
ORDER BY
    order_year,
    order_month;

##3. Calculate the year-over-year growth rate of total sales.

SELECT
    order_year,
    total_sales,
    LAG(total_sales) OVER (ORDER BY order_year) AS previous_year_sales,
    ROUND(
        (total_sales - LAG(total_sales) OVER (ORDER BY order_year)) 
        * 100.0 / LAG(total_sales) OVER (ORDER BY order_year),
        2
    ) AS yoy_growth_percentage
FROM (
    SELECT
        YEAR(o.order_purchase_timestamp) AS order_year,
        SUM(oi.price) AS total_sales
    FROM orders o
    JOIN order_items oi
        ON o.order_id = oi.order_id
    GROUP BY YEAR(o.order_purchase_timestamp)
) yearly_sales
ORDER BY order_year;

##4. Calculate the retention rate of customers,defined as the percentage of customer who make another purcahse within 6 month of their purchase.

SELECT
    COUNT(DISTINCT customer_unique_id) AS total_customers,
    COUNT(DISTINCT CASE
        WHEN order_purchase_timestamp > first_order_date
             AND order_purchase_timestamp <= DATE_ADD(first_order_date, INTERVAL 6 MONTH)
        THEN customer_unique_id
    END) AS retained_customers,
    ROUND(
        COUNT(DISTINCT CASE
            WHEN order_purchase_timestamp > first_order_date
                 AND order_purchase_timestamp <= DATE_ADD(first_order_date, INTERVAL 6 MONTH)
            THEN customer_unique_id
        END) * 100.0
        / COUNT(DISTINCT customer_unique_id),
        2
    ) AS retention_rate_percentage
FROM (
    SELECT
        c.customer_unique_id,
        o.order_purchase_timestamp,
        MIN(o.order_purchase_timestamp) OVER (PARTITION BY c.customer_unique_id) AS first_order_date
    FROM orders o
    JOIN customers c
        ON o.customer_id = c.customer_id
) t;

##5. Identify the top 3 customer s who spent the most money in each year.

SELECT
    order_year,
    customer_id,
    total_spent
FROM (
    SELECT
        YEAR(o.order_purchase_timestamp) AS order_year,
        o.customer_id,
        SUM(oi.price) AS total_spent,
        DENSE_RANK() OVER (
            PARTITION BY YEAR(o.order_purchase_timestamp)
            ORDER BY SUM(oi.price) DESC
        ) AS rank_in_year
    FROM orders o
    JOIN order_items oi
        ON o.order_id = oi.order_id
    GROUP BY
        YEAR(o.order_purchase_timestamp),
        o.customer_id
) ranked_customers
WHERE rank_in_year <= 3
ORDER BY order_year, rank_in_year;

##top 3

SELECT
    o.customer_id,
    SUM(oi.price) AS total_spent
FROM orders o
JOIN order_items oi
    ON o.order_id = oi.order_id
GROUP BY o.customer_id
ORDER BY total_spent DESC
LIMIT 3;








